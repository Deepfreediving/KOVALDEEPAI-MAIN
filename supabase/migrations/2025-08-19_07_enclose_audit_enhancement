-- Enhanced E.N.C.L.O.S.E. Audit System Migration
-- Add columns for structured audit evaluation and scoring

-- Add enhanced audit columns to support E.N.C.L.O.S.E. framework
alter table dive_log_audit
  add column if not exists criteria_version text default 'koval_enclose_v1',
  add column if not exists model text,
  add column if not exists score_final numeric(5,2),
  add column if not exists score_safety smallint,
  add column if not exists score_technique smallint,
  add column if not exists score_efficiency smallint,
  add column if not exists score_readiness smallint,
  add column if not exists enclose jsonb default '[]'::jsonb;

-- Create view for dive metrics computation (using correct column names and safe references)
create or replace view v_dive_metrics as
select
  l.*,
  -- Descent speed calculation (handle various possible column names)
  case 
    when l.descent_speed_mps is not null then l.descent_speed_mps
    when l.reached_depth is not null and l.descent_seconds is not null and l.descent_seconds > 0
         then l.reached_depth::numeric / l.descent_seconds
    else null 
  end as descent_mps,
  -- Ascent speed calculation  
  case 
    when l.ascent_speed_mps is not null then l.ascent_speed_mps
    when l.reached_depth is not null and l.ascent_seconds is not null and l.ascent_seconds > 0
         then l.reached_depth::numeric / l.ascent_seconds
    else null 
  end as ascent_mps,
  -- VDI (Vertical Distance Index) calculation
  case 
    when l.reached_depth is not null and l.total_time_seconds is not null and l.reached_depth > 0
         then l.total_time_seconds::numeric / l.reached_depth
    else null 
  end as vdi_sec_per_meter
from dive_log l;

-- Create view for user E.N.C.L.O.S.E. summary (simplified to avoid nested aggregates)
create or replace view v_user_enclose_summary as
select
  a.user_id,
  count(*) as total_audits,
  avg(a.score_final) as avg_score,
  -- Simple aggregation of E.N.C.L.O.S.E. data per user
  jsonb_agg(a.enclose) as all_enclose_data
from dive_log_audit a
where a.enclose is not null and jsonb_array_length(a.enclose) > 0
group by a.user_id;

-- Create index for better performance on E.N.C.L.O.S.E. queries
create index if not exists idx_dive_log_audit_enclose on dive_log_audit using gin(enclose);
create index if not exists idx_dive_log_audit_scores on dive_log_audit(user_id, score_final);

-- Grant permissions
grant select on v_dive_metrics to authenticated;
grant select on v_user_enclose_summary to authenticated;
