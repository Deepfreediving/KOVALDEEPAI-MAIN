<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Debugging - Koval AI Widget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .widget-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            height: 600px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .log-info { background-color: #e3f2fd; }
        .log-success { background-color: #e8f5e8; }
        .log-warning { background-color: #fff3e0; }
        .log-error { background-color: #ffebee; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #debugLogs {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>üîß Live Debugging - Koval AI Widget</h1>
    
    <div class="debug-panel">
        <h3>Debug Controls</h3>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="testDiveLogFlow()">Test Dive Log Flow</button>
        <button onclick="testChatFlow()">Test Chat Flow</button>
        <button onclick="checkUserState()">Check User State</button>
        
        <h4>Debug Messages</h4>
        <div id="debugLogs"></div>
    </div>

    <div class="widget-container">
        <iframe id="kovalWidget" 
                src="http://localhost:3000/embed?userId=test-user-123&nickname=TestNickname&theme=light&embedded=true" 
                width="100%" 
                height="100%" 
                frameborder="0">
        </iframe>
    </div>

    <script>
        let logContainer = document.getElementById('debugLogs');
        let widget = document.getElementById('kovalWidget');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            logContainer.innerHTML = '';
        }

        // Listen for messages from the embedded widget
        window.addEventListener('message', function(event) {
            if (event.origin !== 'http://localhost:3000') return;
            
            const data = event.data;
            if (data.source === 'koval-ai-embed') {
                log(`üì® Message from widget: ${data.type}`, 'info');
                
                if (data.type === 'EMBED_READY') {
                    log('‚úÖ Widget is ready, sending mock Wix data...', 'success');
                    sendMockWixData();
                } else if (data.type === 'USER_DATA_REQUEST') {
                    log('üë§ Widget requested user data', 'info');
                    sendMockWixData();
                } else if (data.type === 'DIVE_LOG_SAVED') {
                    log(`üìù Dive log saved: ${JSON.stringify(data.data)}`, 'success');
                } else if (data.type === 'ERROR') {
                    log(`‚ùå Error from widget: ${data.message}`, 'error');
                }
            }
        });

        function sendMockWixData() {
            const mockData = {
                type: 'WIX_DATA_UPDATE',
                source: 'wix-parent',
                data: {
                    user: {
                        id: 'test-user-123',
                        nickname: 'TestNickname',
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@example.com',
                        profilePicture: null
                    },
                    members: {
                        fullData: {
                            _id: 'test-user-123',
                            nickname: 'TestNickname',
                            contactDetails: {
                                firstName: 'Test',
                                lastName: 'User',
                                emails: ['test@example.com']
                            },
                            profile: {
                                nickname: 'TestNickname',
                                profilePicture: null
                            }
                        }
                    }
                }
            };
            
            widget.contentWindow.postMessage(mockData, 'http://localhost:3000');
            log('üì§ Sent mock Wix data to widget', 'info');
        }

        function testDiveLogFlow() {
            log('üß™ Testing dive log flow...', 'info');
            const testLog = {
                type: 'TEST_DIVE_LOG',
                data: {
                    date: new Date().toISOString().split('T')[0],
                    location: 'Test Pool',
                    depth: 25,
                    time: 120,
                    notes: 'Test dive log from debugging interface'
                }
            };
            widget.contentWindow.postMessage(testLog, 'http://localhost:3000');
        }

        function testChatFlow() {
            log('üí¨ Testing chat flow...', 'info');
            const testMessage = {
                type: 'TEST_CHAT',
                data: {
                    message: 'Hello, can you analyze my recent dive logs?'
                }
            };
            widget.contentWindow.postMessage(testMessage, 'http://localhost:3000');
        }

        function checkUserState() {
            log('üë§ Checking user state...', 'info');
            widget.contentWindow.postMessage({ type: 'GET_USER_STATE' }, 'http://localhost:3000');
        }

        // Initial setup
        log('üöÄ Starting live debugging session...', 'info');
        log('Widget URL: ' + widget.src, 'info');
    </script>
</body>
</html>
