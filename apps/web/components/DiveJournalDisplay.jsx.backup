import { useEffect, useState, useCallback } from "react";
import Image from "next/image";

// Generate UUID helper function
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

export default function DiveJournalDisplay({
  darkMode,
  isOpen,
  onClose,
  isEmbedded = false,
  setMessages,
  onDiveLogSaved, // üöÄ NEW: Callback when dive log is saved
  onDiveLogDeleted, // üöÄ NEW: Callback when dive log is deleted
  onRefreshDiveLogs, // üöÄ NEW: Callback to refresh dive logs in parent
  editingLog = null, // üöÄ NEW: Log to edit (pre-fills form)
  diveLogs = [], // üöÄ NEW: Dive logs passed from parent
  loadingDiveLogs = false, // üöÄ NEW: Loading state from parent
  currentUser = null, // üöÄ NEW: Pass user from parent
  userProfile = null // üöÄ NEW: Pass profile from parent
}) {
  const [logs, setLogs] = useState([]);
  const [sortBy, setSortBy] = useState("date");
  const [activeTab, setActiveTab] = useState("saved-logs"); // Tab navigation: saved-logs, add-new, batch-analysis
  const [isSaving, setIsSaving] = useState(false); // Loading state for save operation
  
  // Batch analysis state
  const [batchAnalysis, setBatchAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisType, setAnalysisType] = useState("pattern");
  const [timeRange, setTimeRange] = useState("all");
  const [analysisHistory, setAnalysisHistory] = useState([]);
  
  // Advanced filtering state
  const [filters, setFilters] = useState({
    discipline: "",
    location: "",
    dateFrom: "",
    dateTo: "",
    hasIssues: ""
  });
  
  // üöÄ Get authenticated user data  
  // Get current user ID - prefer authenticated user, fallback to profile
  const getCurrentUserId = () => {
    if (currentUser?.id) {
      // Validate that it's a UUID, not a timestamp
      const userId = currentUser.id;
      if (typeof userId === 'string' && userId.length > 20 && userId.includes('-')) {
        return userId;
      }
    }
    if (userProfile?.userId) {
      const userId = userProfile.userId;
      if (typeof userId === 'string' && userId.length > 20 && userId.includes('-')) {
        return userId;
      }
    }
    return "123e4567-e89b-12d3-a456-426614174000"; // Use our test UUID with real dive data
  };
  
  const currentUserId = getCurrentUserId();
  const [newEntry, setNewEntry] = useState({
    date: new Date().toISOString().split("T")[0],
    disciplineType: "depth",
    discipline: "CWT", // ‚úÖ Default to valid enum value
    location: "",
    targetDepth: "",
    reachedDepth: "",
    mouthfillDepth: "",
    issueDepth: "",
    issueComment: "",
    squeeze: false,
    exit: "clean", // ‚úÖ Default to valid enum value
    durationOrDistance: "",
    totalDiveTime: "",
    attemptType: "", // ‚úÖ Empty = NULL (valid)
    surfaceProtocol: "", // ‚úÖ Empty = NULL (valid)
    notes: "",
    imageFile: null,
    imagePreview: null,
    diveComputerFile: null,
    diveComputerFileName: "",
    // Advanced fields
    bottomTime: "",
    earSqueeze: false,
    lungSqueeze: false,
    narcosisLevel: "",
    recoveryQuality: "",
    gear: {
      wetsuit: "",
      fins: "",
      mask: "",
      weights_kg: "",
      nose_clip: false,
      lanyard: false,
      computer: ""
    }
  });
  const [analyzingLogId, setAnalyzingLogId] = useState(null); // Track which log is being analyzed
  const [isEditMode, setIsEditMode] = useState(false); // Track if we're editing

  // ‚úÖ Handle editing mode - pre-fill form when editingLog is provided
  useEffect(() => {
    if (editingLog) {
      console.log(
        "üìù DiveJournalDisplay: Entering edit mode for log:",
        editingLog.id,
      );
      setNewEntry({
        ...editingLog,
        imageFile: null, // Reset file input
        imagePreview: editingLog.imageUrl || null, // Use existing image URL if available
      });
      setIsEditMode(true);
      setActiveTab("add-new"); // Switch to form tab
    } else {
      setIsEditMode(false);
    }
  }, [editingLog]);

  // Update logs when parent passes new data
  useEffect(() => {
    setLogs(diveLogs);
  }, [diveLogs]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    
    // Handle gear object updates
    if (name.startsWith('gear.')) {
      const gearField = name.split('.')[1];
      setNewEntry((prev) => ({
        ...prev,
        gear: {
          ...prev.gear,
          [gearField]: type === "checkbox" ? checked : value,
        }
      }));
    } else {
      setNewEntry((prev) => ({
        ...prev,
        [name]: type === "checkbox" ? checked : value,
      }));
    }
  };

  const handleImageChange = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      console.log("üì∏ Image file selected:", {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified
      });
      
      // Validate file size (10MB limit)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        alert(`File too large! Maximum size is ${maxSize / 1024 / 1024}MB. Your file is ${(file.size / 1024 / 1024).toFixed(2)}MB.`);
        return;
      }
      
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        alert(`Invalid file type! Allowed types: ${allowedTypes.join(', ')}`);
        return;
      }
      
      setNewEntry((prev) => ({
        ...prev,
        imageFile: file,
        imagePreview: URL.createObjectURL(file),
      }));
      
      console.log("‚úÖ Image file ready for upload");
    } else {
      console.log("‚ùå No file selected");
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // üö® IMMEDIATE DEBUG: Alert to confirm function is called
    alert("üöÄ Form submission started! Check console for details.");
    
    console.log("üöÄ DiveJournalDisplay: Starting dive log submit process...");
    console.log("üîç Event:", e);
    console.log("üîç newEntry state:", newEntry);
    console.log("üîç currentUserId:", currentUserId);
    console.log("üîç isSaving before:", isSaving);

    // Set saving state
    setIsSaving(true);
    console.log("‚úÖ DiveJournalDisplay: Set isSaving to true");

    // Add a visible indicator that save was triggered
    if (setMessages) {
      setMessages((prev) => [
        ...prev,
        {
          role: "assistant",
          content: "üöÄ **Starting Save Process**\n\nProcessing your dive log submission...",
        },
      ]);
    }

    // ‚úÖ VALIDATION: Check required fields
    if (!newEntry.date) {
      console.error("‚ùå Validation failed: Date is required");
      if (setMessages) {
        setMessages((prev) => [
          ...prev,
          {
            role: "assistant",
            content: "‚ùå **Validation Error**\n\nDate field is required. Please fill in all required fields.",
          },
        ]);
      }
      setIsSaving(false);
      return;
    }

    const toNum = (v) => v === '' || v == null ? null : Number(v);

    // ‚úÖ CRITICAL: Ensure date is always present and valid
    const ensureValidDate = (date) => {
      if (!date || date === '' || date === null || date === undefined) {
        return new Date().toISOString().split("T")[0];
      }
      // Validate date format (YYYY-MM-DD)
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!dateRegex.test(date)) {
        console.warn('‚ö†Ô∏è Invalid date format, using today:', date);
        return new Date().toISOString().split("T")[0];
      }
      return date;
    };

    const newLog = {
      ...newEntry,
      id: isEditMode ? editingLog.id : generateUUID(), // ‚úÖ Generate proper UUID instead of timestamp
      timestamp: new Date().toISOString(),
      nickname: userProfile?.nickname || currentUser?.email?.split('@')[0] || "User",
      user_id: currentUserId, // ‚úÖ Use real user ID
      imageFile: newEntry.imageFile, // ‚úÖ Preserve image file for processing
      imagePreview: newEntry.imagePreview, // ‚úÖ Preserve image preview
      // ‚úÖ CRITICAL: Ensure date is always present and properly formatted
      date: ensureValidDate(newEntry.date),
      // Convert form data to database schema
      target_depth: toNum(newEntry.targetDepth),
      reached_depth: toNum(newEntry.reachedDepth),
      mouthfill_depth: toNum(newEntry.mouthfillDepth),
      issue_depth: toNum(newEntry.issueDepth),
      issue_comment: newEntry.issueComment || null,
      exit_status: newEntry.exit || null,
      duration_seconds: newEntry.disciplineType === 'pool' ? toNum(newEntry.durationOrDistance) : null,
      distance_m: newEntry.disciplineType === 'pool' ? null : toNum(newEntry.durationOrDistance),
      total_time_seconds: toNum(newEntry.totalDiveTime),
      attempt_type: newEntry.attemptType || null,
      surface_protocol: newEntry.surfaceProtocol || null,
      bottom_time: toNum(newEntry.bottomTime),
      ear_squeeze: newEntry.earSqueeze || null,
      lung_squeeze: newEntry.lungSqueeze || null,
      narcosis_level: toNum(newEntry.narcosisLevel),
      recovery_quality: toNum(newEntry.recoveryQuality),
      gear: newEntry.gear || {}
    };

    console.log("üìù DiveJournalDisplay: Prepared dive log data:", {
      id: newLog.id,
      nickname: newLog.nickname,
      location: newLog.location,
      depth: newLog.reachedDepth || newLog.targetDepth,
      date: newLog.date,
      isEditMode,
      hasImage: !!newEntry.imageFile,
    });

    try {
      // üöÄ STEP 1: Save dive log to Supabase FIRST to get valid database ID
      console.log("üåê DiveJournalDisplay: Saving dive log to Supabase first...");
      console.log("üîç newLog data being sent:", JSON.stringify(newLog, null, 2));
      console.log("üîç currentUserId:", currentUserId);
      
      const response = await fetch("/api/supabase/save-dive-log", {
        method: isEditMode ? "PUT" : "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(newLog),
      });

      console.log("üì• DiveJournalDisplay: Save API response status:", response.status);
      const responseText = await response.text();
      console.log("üì• DiveJournalDisplay: Save API response body:", responseText);

      if (!response.ok) {
        const errorData = responseText ? JSON.parse(responseText) : { error: "Unknown error" };
        console.error("‚ùå DiveJournalDisplay: Save API error:", errorData);
        
        // Show error message in chat instead of setError
        if (setMessages) {
          setMessages((prev) => [
            ...prev,
            {
              role: "assistant",
              content: `‚ùå **Save Failed** \n\nFailed to save dive log: ${errorData.error || `HTTP ${response.status}: Failed to save dive log`}. Please try again.`,
            },
          ]);
        }
        
        setIsSaving(false);
        return;
      }

      const saveResult = JSON.parse(responseText);
      console.log("‚úÖ DiveJournalDisplay: Dive log saved successfully:", saveResult);
      
      // Get the saved dive log ID for image linking
      const savedDiveLogId = saveResult.data?.id || newLog.id;
      console.log("üÜî Using dive log ID for image linking:", savedDiveLogId);

      // üöÄ STEP 2: Handle image upload AFTER dive log is saved
      let imageAnalysis = null;
      if (newEntry.imageFile) {
        console.log("üì∏ DiveJournalDisplay: Uploading and analyzing image...");
        
        // Show immediate feedback
        if (setMessages) {
          setMessages((prev) => [
            ...prev,
            {
              role: "assistant",
              content: "üì∏ Analyzing your dive profile image...",
            },
          ]);
        }
        
        try {
          const formData = new FormData();
          formData.append('image', newEntry.imageFile);
          formData.append('diveLogId', savedDiveLogId); // ‚úÖ Use saved dive log ID
          formData.append('userId', currentUserId); // ‚úÖ Use real user ID
          
          console.log("üì§ Uploading image file:", {
            name: newEntry.imageFile.name,
            size: newEntry.imageFile.size,
            type: newEntry.imageFile.type,
            diveLogId: savedDiveLogId,
            userId: currentUserId,
          });
          
          // Log FormData contents for debugging
          for (let [key, value] of formData.entries()) {
            console.log(`üìù FormData ${key}:`, value instanceof File ? `File(${value.name}, ${value.size}bytes)` : value);
          }
          
          const imageResponse = await fetch('/api/dive/upload-image', {
            method: 'POST',
            body: formData,
          });
          
          console.log("üì° Image upload response status:", imageResponse.status);
          console.log("üì° Image upload response headers:", Object.fromEntries(imageResponse.headers.entries()));
          
          const imageResponseText = await imageResponse.text();
          console.log("üì• Image upload response body:", imageResponseText);
          
          if (imageResponse.ok) {
            const imageResult = JSON.parse(imageResponseText);
            console.log("‚úÖ DiveJournalDisplay: Image analyzed successfully:", imageResult);
            imageAnalysis = imageResult.data;
            
            // Show image analysis in chat
            if (setMessages && imageAnalysis) {
              setMessages((prev) => [
                ...prev,
                {
                  role: "assistant",
                  content: `üì∏ **Image Analysis Complete**\n\n${imageResult.message || 'Dive profile image has been analyzed and will be included in your coaching feedback.'}\n\n${imageResult.data?.extractedText ? `**Detected Text:** ${imageResult.data.extractedText}` : ''}`,
                },
              ]);
            }
          } else {
            console.warn("‚ö†Ô∏è DiveJournalDisplay: Image upload failed:", imageResponse.status, imageResponseText);
            if (setMessages) {
              setMessages((prev) => [
                ...prev,
                {
                  role: "assistant",
                  content: "‚ö†Ô∏è Image analysis failed, but your dive log has been saved successfully.",
                },
              ]);
            }
          }
        } catch (imageError) {
          console.error("‚ùå DiveJournalDisplay: Image processing error:", imageError);
          if (setMessages) {
            setMessages((prev) => [
              ...prev,
              {
                role: "assistant",
                content: "‚ùå Image processing error occurred. Your dive log has been saved successfully without the image.",
              },
            ]);
          }
        }
      }

      // üöÄ STEP 3: Process saved dive log data and update UI
      console.log("‚úÖ DiveJournalDisplay: Save successful:", saveResult);

      // üéâ Show success message immediately
      if (setMessages) {
        setMessages((prev) => [
          ...prev,
          {
            role: "assistant",
            content: `‚úÖ **Dive Log Saved Successfully!**\n\nYour ${saveResult.diveLog?.discipline || 'dive'} to ${saveResult.diveLog?.reached_depth || saveResult.diveLog?.target_depth}m at ${saveResult.diveLog?.location || 'unknown location'} has been saved.\n\nüß† Analyzing your dive for coaching insights...`,
          },
        ]);
      }

      // Update dive log with server response data
      const savedDiveLog = saveResult.diveLog || saveResult.data || saveResult;
      newLog.id = savedDiveLog.id || newLog.id;
      newLog.created_at = savedDiveLog.created_at || new Date().toISOString();

        // üöÄ STEP 2: Update local state with proper deduplication
        let updatedLogs;
        if (isEditMode) {
          updatedLogs = logs.map((log) =>
            log.id === newLog.id ? newLog : log,
          );
          console.log(
            "‚úÖ DiveJournalDisplay: Updated existing log in local state",
          );
        } else {
          // Check for duplicates before adding
          const existingLog = logs.find(
            (log) =>
              log.id === newLog.id ||
              (log.date === newLog.date &&
                log.reachedDepth === newLog.reachedDepth &&
                log.location === newLog.location),
          );

          if (existingLog) {
            console.log(
              "‚ö†Ô∏è DiveJournalDisplay: Duplicate log detected, updating instead of adding",
            );
            updatedLogs = logs.map((log) =>
              log.id === newLog.id ||
              (log.date === newLog.date &&
                log.reachedDepth === newLog.reachedDepth &&
                log.location === newLog.location)
                ? newLog
                : log,
            );
          } else {
            updatedLogs = [...logs, newLog];
            console.log("‚úÖ DiveJournalDisplay: Added new log to local state");
          }
        }
        setLogs(updatedLogs);

        // üöÄ STEP 3: Update localStorage IMMEDIATELY with deduplication
        try {
          const storageKey = `diveLogs_${currentUserId}`; // ‚úÖ Use real user ID
          console.log(
            "üíæ DiveJournalDisplay: Updating localStorage with key:",
            storageKey,
          );

          // Get existing logs from localStorage (not just component state)
          const existingLogs = JSON.parse(
            localStorage.getItem(storageKey) || "[]",
          );
          console.log(
            "üìã DiveJournalDisplay: Found",
            existingLogs.length,
            "existing logs in localStorage",
          );

          // Deduplicate logs in localStorage too
          const filteredExisting = existingLogs.filter(
            (log) =>
              log.id !== newLog.id &&
              !(
                log.date === newLog.date &&
                log.reachedDepth === newLog.reachedDepth &&
                log.location === newLog.location
              ),
          );

          // Add new log and sort by date
          const finalLogs = [...filteredExisting, newLog].sort(
            (a, b) => new Date(b.date) - new Date(a.date),
          );

          // Save to localStorage
          localStorage.setItem(storageKey, JSON.stringify(finalLogs));
          console.log(
            "‚úÖ DiveJournalDisplay: localStorage updated successfully",
          );
          console.log("   ‚Ä¢ Storage key:", storageKey);
          console.log("   ‚Ä¢ Total logs stored:", finalLogs.length);
          console.log("   ‚Ä¢ New log ID:", newLog.id);

          // üîç VERIFICATION: Check if data was actually saved
          const verifyStorage = localStorage.getItem(storageKey);
          if (verifyStorage) {
            const verifyLogs = JSON.parse(verifyStorage);
            console.log(
              "‚úÖ DiveJournalDisplay: localStorage verification passed -",
              verifyLogs.length,
              "logs found",
            );
            
            // üöÄ FORCE REFRESH: Update component state with verified data
            setLogs(verifyLogs);
            console.log("üîÑ DiveJournalDisplay: Component state synchronized with localStorage");
          } else {
            console.error(
              "‚ùå DiveJournalDisplay: localStorage verification failed - no data found",
            );
          }
        } catch (storageError) {
          console.error(
            "‚ùå DiveJournalDisplay: Failed to update localStorage:",
            storageError,
          );
          console.log("   ‚Ä¢ Storage key attempted:", `diveLogs_${currentUserId}`); // ‚úÖ Fixed: Use real user ID
          console.log("   ‚Ä¢ Current user ID:", currentUserId);
          console.log(
            "   ‚Ä¢ Browser storage available:",
            typeof localStorage !== "undefined",
          );
        }

        // üöÄ STEP 4: Notify parent components
        if (onDiveLogSaved) {
          console.log(
            "üì¢ DiveJournalDisplay: Notifying parent of successful save...",
          );
          onDiveLogSaved(newLog, saveResult);
        }

        if (onRefreshDiveLogs) {
          console.log(
            "üîÑ DiveJournalDisplay: Triggering parent dive logs refresh...",
          );
          onRefreshDiveLogs();
        }

        // üöÄ ADDITIONAL: Force sidebar refresh by dispatching storage event
        try {
          window.dispatchEvent(new StorageEvent('storage', {
            key: `diveLogs_${currentUserId}`, // ‚úÖ FIXED: Use real user ID consistently
            newValue: localStorage.getItem(`diveLogs_${currentUserId}`), // ‚úÖ FIXED: Use real user ID consistently
            storageArea: localStorage
          }));
          console.log("üì° DiveJournalDisplay: Dispatched storage event for sidebar refresh");
        } catch (eventError) {
          console.warn("‚ö†Ô∏è DiveJournalDisplay: Could not dispatch storage event:", eventError);
        }

        // üöÄ STEP 5: Show success message in chat
        if (setMessages) {
          setMessages((prev) => [
            ...prev,
            {
              role: "assistant",
              content: `‚úÖ **Dive Log ${isEditMode ? "Updated" : "Saved"}** \n\n${newLog.discipline || "Freediving"} dive to ${newLog.reachedDepth || newLog.targetDepth}m at ${newLog.location || "location"} has been ${isEditMode ? "updated" : "saved"} successfully.`,
            },
          ]);
        }

        // üöÄ STEP 6: Automatically trigger AI analysis for new logs
        if (!isEditMode && setMessages) {
          console.log("ü§ñ DiveJournalDisplay: Triggering automatic AI analysis...");
          setTimeout(async () => {
            try {
              setMessages((prev) => [
                ...prev,
                {
                  role: "assistant",
                  content: `üîÑ **Analyzing Your Dive**\n\nI'm now analyzing your ${newLog.discipline || "freediving"} dive to ${newLog.reachedDepth || newLog.targetDepth}m for coaching feedback...`,
                },
              ]);

              // Use the main chat endpoint for better integration
              const analysisResponse = await fetch("/api/openai/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  message: `Please analyze my recent dive and provide coaching feedback:
                  
üìä **Dive Details:**
- Discipline: ${newLog.discipline}
- Target Depth: ${newLog.targetDepth}m 
- Reached Depth: ${newLog.reachedDepth}m
- Total Time: ${newLog.totalDiveTime}
- Location: ${newLog.location}
- Notes: ${newLog.notes || 'None'}

${imageAnalysis ? `üì∏ **Vision Analysis Available:** Image analysis data included` : ''}

Please provide specific coaching feedback using Daniel Koval's methodology and safety protocols.`,
                  userId: currentUserId, // ‚úÖ Use real user ID
                  nickname: userProfile?.nickname || currentUser?.email?.split('@')[0] || 'User',
                  embedMode: false,
                  diveLogs: [newLog],
                }),
              });

              if (analysisResponse.ok) {
                const analysisResult = await analysisResponse.json();
                let coachingFeedback = analysisResult.assistantMessage?.content;
                
                // ‚úÖ Handle new JSON response format
                if (coachingFeedback) {
                  try {
                    const parsedFeedback = JSON.parse(coachingFeedback);
                    if (parsedFeedback.congratulations) {
                      // Format structured JSON response
                      coachingFeedback = `${parsedFeedback.congratulations}

**üõ°Ô∏è Safety Assessment:**
${parsedFeedback.safety_assessment}

**üìä Performance Analysis:**
${parsedFeedback.performance_analysis}

**üéØ Coaching Feedback:**
${parsedFeedback.coaching_feedback}

**‚û°Ô∏è Next Steps:**
${parsedFeedback.next_steps}

${parsedFeedback.medical_disclaimer}`;
                    }
                  } catch (parseError) {
                    // Keep original response if JSON parsing fails
                    console.log("Using original response format");
                  }
                  
                  setMessages((prev) => [
                    ...prev,
                    {
                      role: "assistant",
                      content: `üìä **KovalAI Coaching Analysis**\n\n${coachingFeedback}`,
                    },
                  ]);
                  console.log("‚úÖ DiveJournalDisplay: Auto-analysis completed");
                } else {
                  console.warn("‚ö†Ô∏è DiveJournalDisplay: No coaching feedback received");
                }
              }
            } catch (autoAnalysisError) {
              console.error("‚ùå DiveJournalDisplay: Auto-analysis error:", autoAnalysisError);
            }
          }, 1500); // Small delay to let save message show first
        }

        // Reset form and close popup after successful save
        resetForm();

        // üöÄ FORCE CLOSE popup journal after save (with multiple attempts)
        if (onClose && !isEmbedded) {
          console.log("üîí DiveJournalDisplay: Closing popup journal after successful save");
          
          // Try immediate close
          onClose();
          
          // Backup close attempt after delay
          setTimeout(() => {
            if (onClose) {
              console.log("üîí DiveJournalDisplay: Backup close attempt");
              onClose();
            }
          }, 500);
        }

        // üöÄ Switch back to saved logs tab if embedded
        if (isEmbedded) {
          setActiveTab("saved-logs");
        }

        console.log(
          "‚úÖ DiveJournalDisplay: Dive log submit process completed successfully",
        );
    } catch (error) {
      console.error(
        "‚ùå DiveJournalDisplay: Failed to save dive log via API:",
        error,
      );

      // Show error message in chat
      if (setMessages) {
        setMessages((prev) => [
          ...prev,
          {
            role: "assistant",
            content: `‚ùå **Save Failed** \n\nFailed to ${isEditMode ? "update" : "save"} dive log: ${error.message}. Please try again.`,
          },
        ]);
      }
    } finally {
      // Reset saving state
      setIsSaving(false);
    }
  };

  const resetForm = () => {
    setNewEntry({
      date: new Date().toISOString().split("T")[0],
      disciplineType: "depth",
      discipline: "",
      location: "",
      targetDepth: "",
      reachedDepth: "",
      mouthfillDepth: "",
      issueDepth: "",
      issueComment: "",
      squeeze: false,
      exit: "",
      durationOrDistance: "",
      totalDiveTime: "",
      attemptType: "",
      surfaceProtocol: "",
      notes: "",
      imageFile: null,
      imagePreview: null,
      diveComputerFile: null,
      diveComputerFileName: "",
    });
    setIsEditMode(false);
  };

  // üöÄ NEW: Batch Analysis Functions
  const handleBatchAnalysis = async () => {
    if (!currentUserId) {
      console.error("‚ùå No user ID for batch analysis");
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: "‚ùå **Analysis Failed**\n\nUser authentication required for batch analysis." }
        ]);
      }
      return;
    }

    if (logs.length === 0) {
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: "üìä **No Logs to Analyze**\n\nYou need to have at least one dive log before running batch analysis." }
        ]);
      }
      return;
    }

    setIsAnalyzing(true);
    console.log(`üîç Starting batch analysis - Type: ${analysisType}, Range: ${timeRange}`);

    if (setMessages) {
      setMessages(prev => [
        ...prev,
        { 
          role: "assistant", 
          content: `üîç **Starting Batch Analysis**\n\nAnalyzing your dive logs for ${analysisType} insights over ${timeRange === 'all' ? 'all time' : timeRange}...\n\nThis may take 30-60 seconds.` 
        }
      ]);
    }

    try {
      const response = await fetch('/api/dive/batch-analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUserId,
          analysisType: analysisType,
          timeRange: timeRange
        }),
      });

      if (!response.ok) {
        throw new Error(`Analysis API failed: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();

      if (result.success && result.analysis) {
        setBatchAnalysis(result.analysis);
        
        // Add to analysis history
        setAnalysisHistory(prev => [result.analysis, ...prev.slice(0, 4)]); // Keep last 5

        if (setMessages) {
          setMessages(prev => [
            ...prev,
            { 
              role: "assistant", 
              content: `üìä **Batch Analysis Complete**\n\n${result.analysis.result}`
            }
          ]);
        }

        console.log(`‚úÖ Batch analysis completed - Analyzed ${result.analysis.logsAnalyzed} logs`);
      } else {
        throw new Error(result.error || 'Unknown analysis error');
      }
    } catch (error) {
      console.error('‚ùå Batch analysis error:', error);
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { 
            role: "assistant", 
            content: `‚ùå **Batch Analysis Failed**\n\n${error.message}\n\nPlease try again or contact support if the issue persists.` 
          }
        ]);
      }
    } finally {
      setIsAnalyzing(false);
    }
  };

  // üöÄ NEW: Enhanced batch retrieval with filtering
  const handleBatchRetrieval = useCallback(async (newFilters = {}) => {
    if (!currentUserId) {
      console.error("‚ùå No user ID for batch retrieval");
      return;
    }

    console.log('üîç Starting batch retrieval with filters:', newFilters);

    try {
      const queryParams = new URLSearchParams({
        userId: currentUserId,
        limit: 100,
        sortBy: sortBy === 'date' ? 'date' : sortBy,
        sortOrder: 'desc',
        includeAnalysis: 'true',
        ...filters,
        ...newFilters
      });

      const response = await fetch(`/api/dive/batch-logs?${queryParams}`);
      
      if (!response.ok) {
        throw new Error(`Batch retrieval failed: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        // Transform data to match component format
        const transformedLogs = result.diveLogs.map(log => ({
          id: log.id,
          date: log.date,
          disciplineType: log.discipline?.toLowerCase().includes('dnf') ? 'static' : 'depth',
          discipline: log.discipline,
          location: log.location,
          targetDepth: log.target_depth,
          reachedDepth: log.reached_depth,
          mouthfillDepth: log.mouthfill_depth,
          issueDepth: log.issue_depth,
          issueComment: log.issue_comment,
          squeeze: log.squeeze,
          exit: log.exit_protocol,
          durationOrDistance: log.total_dive_time,
          totalDiveTime: log.total_dive_time,
          attemptType: log.attempt_type,
          surfaceProtocol: log.surface_protocol,
          notes: log.notes,
          imageAnalysis: log.ai_analysis,
          analyzed: !!log.ai_analysis,
          bottomTime: log.bottom_time,
          earSqueeze: log.squeeze,
          lungSqueeze: log.squeeze,
          narcosisLevel: 1,
          recoveryQuality: log.feeling_rating || 5
        }));

        setLogs(transformedLogs);
        
        // Update analysis history if available
        if (result.recentAnalyses) {
          setAnalysisHistory(result.recentAnalyses);
        }

        console.log(`‚úÖ Batch retrieval completed - Found ${transformedLogs.length} logs`);

        if (setMessages) {
          setMessages(prev => [
            ...prev,
            { 
              role: "assistant", 
              content: `üìä **Logs Retrieved**\n\nFound ${transformedLogs.length} dive logs.\n\n**Stats:**\n‚Ä¢ Average depth: ${result.stats.averageDepth}m\n‚Ä¢ Deepest dive: ${result.stats.deepestDive}m\n‚Ä¢ Issues found: ${result.stats.issueCount}`
            }
          ]);
        }
      }
    } catch (error) {
      console.error('‚ùå Batch retrieval error:', error);
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: `‚ùå Failed to retrieve dive logs: ${error.message}` }
        ]);
      }
    }
  };

  // üöÄ NEW: Export logs as CSV
  const handleExportLogs = useCallback(async () => {
    if (!currentUserId) {
      console.error("‚ùå No user ID for export");
      return;
    }

    try {
      const queryParams = new URLSearchParams({
        userId: currentUserId,
        format: 'csv',
        ...filters
      });

      const response = await fetch(`/api/dive/batch-logs?${queryParams}`);
      
      if (!response.ok) {
        throw new Error(`Export failed: ${response.status}`);
      }

      // Download the CSV file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `dive-logs-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: "üìÅ **Export Complete**\n\nYour dive logs have been downloaded as a CSV file." }
        ]);
      }
    } catch (error) {
      console.error('‚ùå Export error:', error);
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: `‚ùå Export failed: ${error.message}` }
        ]);
      }
    }
  }, [currentUserId, sortBy, filters, setMessages]);

  // Load logs on component mount
  useEffect(() => {
    if (currentUserId && activeTab === 'saved-logs') {
      handleBatchRetrieval();
    }
  }, [currentUserId, activeTab, handleBatchRetrieval]);

  // Load logs when filters change
  useEffect(() => {
    if (currentUserId && activeTab === 'saved-logs') {
      const timeoutId = setTimeout(() => {
        handleBatchRetrieval();
      }, 500); // Debounce filter changes
      
      return () => clearTimeout(timeoutId);
    }
  }, [filters, currentUserId, activeTab, handleBatchRetrieval]);

  // ‚úÖ Reworked analyze handler - fire-and-forget pattern
  const handleAnalyzeDiveLog = async (log) => {
    if (!log || !currentUserId) {
      console.warn("‚ö†Ô∏è Missing log or currentUserId for analysis", { log, currentUserId });
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: "‚ùå Can't analyze: missing user context." }
        ]);
      }
      return;
    }

    // show immediate feedback in chat
    if (setMessages) {
      const depth = log.reachedDepth ?? log.targetDepth ?? "‚Äî";
      const disc  = log.discipline || "freediving";
      const loc   = log.location || "your location";
      setMessages(prev => [
        ...prev,
        { role: "assistant", content: `üîÑ Analyzing your ${disc} dive to ${depth}m at ${loc}...` }
      ]);
    }

    setAnalyzingLogId?.(log.id);

    // üëâ Close the journal ASAP so the user can keep using chat
    if (onClose && !isEmbedded) {
      // microtask to avoid interfering with current React event
      Promise.resolve().then(() => onClose());
    }

    // Fire the request (do not block UI). We still handle the response to post results.
    const payload = {
      adminUserId: currentUserId,   // ‚úÖ Use real user ID
      nickname: userProfile?.nickname || currentUser?.email?.split('@')[0] || "User",      // ‚úÖ Use real nickname
      diveLogId: log.id,
      diveLogData: log,
    };

    try {
      const resp = await fetch("/api/analyze/dive-log-openai", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`Analyze API failed ${resp.status}: ${txt}`);
      }

      const result = await resp.json();

      if (result?.success && result?.analysis) {
        // Update logs safely (avoid stale closure)
        setLogs?.((prev = []) => {
          const updated = prev.map(l => (l.id === log.id ? { ...l, analysis: result.analysis, analyzed: true } : l));
          try {
            if (typeof window !== "undefined") {
              localStorage.setItem(`diveLogs_${currentUserId}`, JSON.stringify(updated));
            }
          } catch (storageError) {
            console.warn("‚ö†Ô∏è Failed to update localStorage:", storageError);
          }
          return updated;
        });

        // Post analysis to chat
        if (setMessages) {
          setMessages(prev => [
            ...prev,
            { role: "assistant", content: `üìä **Dive Analysis Complete**\n\n${result.analysis}` }
          ]);
        }
      } else {
        const errMsg = result?.error || "Unknown analysis error";
        if (setMessages) {
          setMessages(prev => [
            ...prev,
            { role: "assistant", content: `‚ùå Analysis failed: ${errMsg}` }
          ]);
        }
      }
    } catch (err) {
      console.error("‚ùå Analysis error:", err);
      if (setMessages) {
        setMessages(prev => [
          ...prev,
          { role: "assistant", content: `‚ùå Failed to analyze dive log: ${err.message}` }
        ]);
      }
    } finally {
      setAnalyzingLogId?.(null);
    }
  };

  // üöÄ Add delete functionality with API integration
  const handleDeleteDiveLog = async (logToDelete) => {
    if (!logToDelete || !logToDelete.id) {
      console.warn("‚ö†Ô∏è DiveJournalDisplay: No log to delete");
      return;
    }

    if (
      !confirm(
        `Are you sure you want to delete the dive log from ${logToDelete.date} at ${logToDelete.location || "unknown location"}?`,
      )
    ) {
      return;
    }

    console.log(
      "üóëÔ∏è DiveJournalDisplay: Starting delete process for log:",
      logToDelete.id,
    );

    try {
      // üöÄ STEP 1: Delete from Supabase API
      console.log("üåê DiveJournalDisplay: Deleting from Supabase via API...");
      const response = await fetch("/api/supabase/delete-dive-log", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          adminUserId: currentUserId,
          nickname: userProfile?.nickname || currentUser?.email?.split('@')[0] || "User", // Use real nickname
          logId: logToDelete.id,
          source: "dive-journal-display",
        }),
      });

      console.log(
        "üì• DiveJournalDisplay: Delete API response status:",
        response.status,
      );

      if (response.ok) {
        const result = await response.json();
        console.log("‚úÖ DiveJournalDisplay: Delete successful:", result);

        // üöÄ STEP 2: Update local state
        const updatedLogs = logs.filter((log) => log.id !== logToDelete.id);
        setLogs(updatedLogs);

        // üöÄ STEP 3: Update localStorage
        try {
          localStorage.setItem(
            `diveLogs_${currentUserId}`, // ‚úÖ Fixed: Use real user ID
            JSON.stringify(updatedLogs),
          );
          console.log(
            "üíæ DiveJournalDisplay: Updated localStorage after delete",
          );
        } catch (error) {
          console.warn(
            "‚ö†Ô∏è DiveJournalDisplay: Failed to update localStorage:",
            error,
          );
        }

        // üöÄ STEP 4: Notify parent components
        if (onDiveLogDeleted) {
          console.log(
            "üì¢ DiveJournalDisplay: Notifying parent of successful delete...",
          );
          onDiveLogDeleted(logToDelete, result);
        }

        if (onRefreshDiveLogs) {
          console.log(
            "üîÑ DiveJournalDisplay: Triggering parent dive logs refresh...",
          );
          onRefreshDiveLogs();
        }

        // üöÄ STEP 5: Show success message in chat
        if (setMessages) {
          setMessages((prev) => [
            ...prev,
            {
              role: "assistant",
              content: `üóëÔ∏è **Dive Log Deleted** \n\nThe dive log from ${logToDelete.date} at ${logToDelete.location || "unknown location"} has been removed.`,
            },
          ]);
        }

        console.log(
          "‚úÖ DiveJournalDisplay: Delete process completed successfully",
        );
      } else {
        throw new Error(
          `API delete failed: ${response.status} ${response.statusText}`,
        );
      }
    } catch (error) {
      console.error(
        "‚ùå DiveJournalDisplay: Failed to delete dive log via API:",
        error,
      );

      // Show error message in chat
      if (setMessages) {
        setMessages((prev) => [
          ...prev,
          {
            role: "assistant",
            content: `‚ùå **Delete Failed** \n\nFailed to delete dive log: ${error.message}. Please try again.`,
          },
        ]);
      }
    }
  };

  // If not open and not embedded, don't render
  if (!isEmbedded && !isOpen) return null;

  // Sort logs
  const sortedLogs = [...logs].sort((a, b) => {
    switch (sortBy) {
      case "depth":
        return (b.reachedDepth || 0) - (a.reachedDepth || 0);
      case "location":
        return (a.location || "").localeCompare(b.location || "");
      default: // date
        return new Date(b.date) - new Date(a.date);
    }
  });

  if (isEmbedded) {
    return (
      <div className="h-full flex flex-col">
        {/* Tab Navigation for Embedded */}
        <div
          className={`border-b ${darkMode ? "border-gray-700" : "border-gray-200"}`}
        >
          <div className="flex">
            <button
              onClick={() => setActiveTab("saved-logs")}
              className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                activeTab === "saved-logs"
                  ? darkMode
                    ? "bg-blue-600 text-white border-b-2 border-blue-400"
                    : "bg-blue-500 text-white border-b-2 border-blue-400"
                  : darkMode
                    ? "text-gray-400 hover:text-white hover:bg-gray-800"
                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
              }`}
            >
              üíæ Saved Logs
            </button>
            <button
              onClick={() => setActiveTab("batch-analysis")}
              className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                activeTab === "batch-analysis"
                  ? darkMode
                    ? "bg-blue-600 text-white border-b-2 border-blue-400"
                    : "bg-blue-500 text-white border-b-2 border-blue-400"
                  : darkMode
                    ? "text-gray-400 hover:text-white hover:bg-gray-800"
                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
              }`}
            >
              üìä Analysis
            </button>
            <button
              onClick={() => setActiveTab("add-new")}
              className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                activeTab === "add-new"
                  ? darkMode
                    ? "bg-blue-600 text-white border-b-2 border-blue-400"
                    : "bg-blue-500 text-white border-b-2 border-blue-400"
                  : darkMode
                    ? "text-gray-400 hover:text-white hover:bg-gray-800"
                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
              }`}
            >
              ‚úçÔ∏è {isEditMode ? "Edit" : "New"}
            </button>
          </div>
        </div>

        {/* Tab Content for Embedded */}
        <div className="flex-1 overflow-y-auto p-4" style={{maxHeight: 'calc(100vh - 120px)'}}>
          {/* Saved Dive Logs Tab */}
          {activeTab === "saved-logs" && (
            <div className="space-y-4">
              {loadingDiveLogs ? (
                <div className="text-center py-8">
                  <div className="text-4xl mb-4">‚è≥</div>
                  <p
                    className={`text-lg font-medium ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                  >
                    Loading dive logs...
                  </p>
                </div>
              ) : !logs.length ? (
                <div className="text-center py-8">
                  <div className="text-4xl mb-4">ü§ø</div>
                  <p
                    className={`text-lg font-medium ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                  >
                    No dive logs yet
                  </p>
                  <p
                    className={`text-sm mt-2 ${darkMode ? "text-gray-400" : "text-gray-500"}`}
                  >
                    Add your first dive using the &quot;Create New Dive
                    Log&quot; tab!
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Header with stats and sort */}
                  <div className="flex justify-between items-center">
                    <div
                      className={`text-sm ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                    >
                      <span className="font-medium">{logs.length}</span> dive
                      {logs.length !== 1 ? "s" : ""} logged
                    </div>
                    <select
                      value={sortBy}
                      onChange={(e) => setSortBy(e.target.value)}
                      className={`text-xs px-2 py-1 rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    >
                      <option value="date">Sort by Date</option>
                      <option value="depth">Sort by Depth</option>
                      <option value="location">Sort by Location</option>
                    </select>
                  </div>

                  {/* Dive Logs List */}
                  <div className="space-y-3">
                    {sortedLogs.map((log, index) => (
                      <div
                        key={log.id || index}
                        className={`p-4 rounded-lg border ${
                          darkMode
                            ? "bg-gray-800 border-gray-700"
                            : "bg-white border-gray-200"
                        }`}
                      >
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div
                              className={`font-medium ${darkMode ? "text-white" : "text-gray-900"}`}
                            >
                              {new Date(log.date).toLocaleDateString()} -{" "}
                              {log.discipline || "Freediving"}
                            </div>
                            <div
                              className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-600"}`}
                            >
                              üìç {log.location || "Unknown location"}
                            </div>
                            <div
                              className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-600"}`}
                            >
                              üéØ Target: {log.targetDepth || 0}m | Reached:{" "}
                              {log.reachedDepth || 0}m
                            </div>
                            {log.notes && (
                              <div
                                className={`text-sm mt-2 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                              >
                                üìù {log.notes.slice(0, 100)}
                                {log.notes.length > 100 ? "..." : ""}
                              </div>
                            )}
                          </div>

                          {/* Action Buttons */}
                          <div className="flex flex-col gap-2 ml-4">
                            <button
                              onClick={() => handleAnalyzeDiveLog(log)}
                              disabled={analyzingLogId === log.id}
                              className={`px-3 py-1 text-xs rounded transition-colors ${
                                analyzingLogId === log.id
                                  ? "bg-gray-400 cursor-not-allowed"
                                  : darkMode
                                    ? "bg-blue-600 hover:bg-blue-700 text-white"
                                    : "bg-blue-500 hover:bg-blue-600 text-white"
                              }`}
                            >
                              {analyzingLogId === log.id
                                ? "‚è≥ Analyzing..."
                                : "ü§ñ Analyze"}
                            </button>
                            <button
                              onClick={() => {
                                // Set editing mode and switch to form tab
                                setNewEntry({
                                  ...log,
                                  imageFile: null,
                                  imagePreview: log.imageUrl || null,
                                });
                                setIsEditMode(true);
                                setActiveTab("add-new");
                              }}
                              className={`px-3 py-1 text-xs rounded transition-colors ${
                                darkMode
                                  ? "bg-green-600 hover:bg-green-700 text-white"
                                  : "bg-green-500 hover:bg-green-600 text-white"
                              }`}
                            >
                              ‚úèÔ∏è Edit
                            </button>
                            <button
                              onClick={() => handleDeleteDiveLog(log)}
                              className={`px-3 py-1 text-xs rounded transition-colors ${
                                darkMode
                                  ? "bg-red-600 hover:bg-red-700 text-white"
                                  : "bg-red-500 hover:bg-red-600 text-white"
                              }`}
                            >
                              üóëÔ∏è Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Batch Analysis Tab */}
          {activeTab === "batch-analysis" && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h3 className={`text-lg font-semibold ${darkMode ? "text-white" : "text-gray-900"}`}>
                  üìä Batch Analysis & Pattern Detection
                </h3>
                <button
                  onClick={handleExportLogs}
                  className={`text-sm px-3 py-1 rounded transition-colors ${
                    darkMode
                      ? "bg-green-600 hover:bg-green-700 text-white"
                      : "bg-green-500 hover:bg-green-600 text-white"
                  }`}
                >
                  üìÅ Export CSV
                </button>
              </div>

              {/* Analysis Controls */}
              <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-gray-50 border-gray-200"}`}>
                <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                  Analysis Settings
                </h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      Analysis Type
                    </label>
                    <select
                      value={analysisType}
                      onChange={(e) => setAnalysisType(e.target.value)}
                      className={`w-full px-3 py-2 text-sm rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    >
                      <option value="pattern">üîç Pattern Detection</option>
                      <option value="safety">üõ°Ô∏è Safety Analysis</option>
                      <option value="performance">üìà Performance Review</option>
                      <option value="coaching">üéØ Coaching Insights</option>
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      Time Range
                    </label>
                    <select
                      value={timeRange}
                      onChange={(e) => setTimeRange(e.target.value)}
                      className={`w-full px-3 py-2 text-sm rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    >
                      <option value="week">üìÖ Last Week</option>
                      <option value="month">üìÖ Last Month</option>
                      <option value="quarter">üìÖ Last 3 Months</option>
                      <option value="year">üìÖ Last Year</option>
                      <option value="all">üìÖ All Time</option>
                    </select>
                  </div>
                </div>
                <button
                  onClick={handleBatchAnalysis}
                  disabled={isAnalyzing || logs.length === 0}
                  className={`mt-4 w-full px-4 py-2 rounded transition-colors ${
                    isAnalyzing || logs.length === 0
                      ? "bg-gray-400 cursor-not-allowed text-white"
                      : darkMode
                        ? "bg-blue-600 hover:bg-blue-700 text-white"
                        : "bg-blue-500 hover:bg-blue-600 text-white"
                  }`}
                >
                  {isAnalyzing 
                    ? "üîÑ Analyzing..." 
                    : logs.length === 0 
                      ? "‚ùå No Logs to Analyze" 
                      : `üöÄ Analyze ${logs.length} Dive${logs.length !== 1 ? 's' : ''}`
                  }
                </button>
              </div>

              {/* Advanced Filters */}
              <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-gray-50 border-gray-200"}`}>
                <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                  üìã Filter Logs
                </h4>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className={`block text-xs font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      Discipline
                    </label>
                    <select
                      value={filters.discipline}
                      onChange={(e) => setFilters(prev => ({...prev, discipline: e.target.value}))}
                      className={`w-full px-2 py-1 text-xs rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    >
                      <option value="">All Disciplines</option>
                      <option value="CWT">Constant Weight</option>
                      <option value="CNF">Constant No Fins</option>
                      <option value="FIM">Free Immersion</option>
                      <option value="STA">Static Apnea</option>
                      <option value="DNF">Dynamic No Fins</option>
                      <option value="DYN">Dynamic with Fins</option>
                    </select>
                  </div>
                  <div>
                    <label className={`block text-xs font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      Location
                    </label>
                    <input
                      type="text"
                      value={filters.location}
                      onChange={(e) => setFilters(prev => ({...prev, location: e.target.value}))}
                      placeholder="e.g. Blue Hole"
                      className={`w-full px-2 py-1 text-xs rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    />
                  </div>
                  <div>
                    <label className={`block text-xs font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      From Date
                    </label>
                    <input
                      type="date"
                      value={filters.dateFrom}
                      onChange={(e) => setFilters(prev => ({...prev, dateFrom: e.target.value}))}
                      className={`w-full px-2 py-1 text-xs rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    />
                  </div>
                  <div>
                    <label className={`block text-xs font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                      To Date
                    </label>
                    <input
                      type="date"
                      value={filters.dateTo}
                      onChange={(e) => setFilters(prev => ({...prev, dateTo: e.target.value}))}
                      className={`w-full px-2 py-1 text-xs rounded border ${
                        darkMode
                          ? "bg-gray-700 border-gray-600 text-white"
                          : "bg-white border-gray-300 text-gray-900"
                      }`}
                    />
                  </div>
                </div>
                <div className="mt-3">
                  <label className={`block text-xs font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                    Issues Filter
                  </label>
                  <select
                    value={filters.hasIssues}
                    onChange={(e) => setFilters(prev => ({...prev, hasIssues: e.target.value}))}
                    className={`w-full px-2 py-1 text-xs rounded border ${
                      darkMode
                        ? "bg-gray-700 border-gray-600 text-white"
                        : "bg-white border-gray-300 text-gray-900"
                    }`}
                  >
                    <option value="">All Dives</option>
                    <option value="true">‚ùå Only Dives with Issues</option>
                    <option value="false">‚úÖ Only Clean Dives</option>
                  </select>
                </div>
              </div>

              {/* Current Analysis Result */}
              {batchAnalysis && (
                <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200"}`}>
                  <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                    üß† Latest Analysis Results
                  </h4>
                  <div className={`text-sm ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                    <div className="mb-2">
                      <span className="font-medium">Type:</span> {batchAnalysis.type} | 
                      <span className="font-medium"> Range:</span> {batchAnalysis.timeRange} | 
                      <span className="font-medium"> Logs:</span> {batchAnalysis.logsAnalyzed}
                    </div>
                    <div className={`p-3 rounded bg-gray-100 ${darkMode ? "bg-gray-700" : ""} whitespace-pre-wrap`}>
                      {batchAnalysis.result}
                    </div>
                  </div>
                </div>
              )}

              {/* Analysis History */}
              {analysisHistory.length > 0 && (
                <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200"}`}>
                  <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                    üìö Recent Analysis History
                  </h4>
                  <div className="space-y-2">
                    {analysisHistory.slice(0, 3).map((analysis, index) => (
                      <div
                        key={index}
                        className={`p-2 rounded border cursor-pointer ${
                          darkMode ? "bg-gray-700 border-gray-600 hover:bg-gray-600" : "bg-gray-50 border-gray-200 hover:bg-gray-100"
                        }`}
                        onClick={() => setBatchAnalysis(analysis)}
                      >
                        <div className={`text-xs ${darkMode ? "text-gray-300" : "text-gray-600"}`}>
                          {analysis.type} ‚Ä¢ {analysis.timeRange} ‚Ä¢ {analysis.logsAnalyzed} logs ‚Ä¢ {new Date(analysis.createdAt).toLocaleDateString()}
                        </div>
                        <div className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-700"} truncate`}>
                          {analysis.result.substring(0, 100)}...
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Add New / Edit Dive Log Tab */}
          {activeTab === "add-new" && (
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3
                  className={`text-lg font-semibold ${darkMode ? "text-white" : "text-gray-900"}`}
                >
                  {isEditMode ? "‚úèÔ∏è Edit Dive Log" : "‚úçÔ∏è Create New Dive Log"}
                </h3>
                {isEditMode && (
                  <button
                    onClick={() => {
                      resetForm();
                      setActiveTab("saved-logs");
                    }}
                    className={`text-sm px-3 py-1 rounded ${
                      darkMode
                        ? "bg-gray-600 hover:bg-gray-700 text-gray-300"
                        : "bg-gray-200 hover:bg-gray-300 text-gray-700"
                    }`}
                  >
                    Cancel Edit
                  </button>
                )}
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                {/* Basic Information */}
                <div
                  className={`p-4 rounded-lg ${darkMode ? "bg-gray-800 border border-gray-700" : "bg-blue-50 border border-blue-200"}`}
                >
                  <h4
                    className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                  >
                    üìÖ Basic Information
                  </h4>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Date
                      </label>
                      <input
                        name="date"
                        type="date"
                        value={newEntry.date}
                        onChange={handleInputChange}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                        required
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Type
                      </label>
                      <select
                        name="disciplineType"
                        value={newEntry.disciplineType}
                        onChange={handleInputChange}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      >
                        <option value="depth">Depth</option>
                        <option value="pool">Pool</option>
                      </select>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Discipline
                      </label>
                      <select
                        name="discipline"
                        value={newEntry.discipline}
                        onChange={handleInputChange}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      >
                        <option value="CWT">CWT (Constant Weight)</option>
                        <option value="CNF">CNF (Constant No Fins)</option>
                        <option value="FIM">FIM (Free Immersion)</option>
                        <option value="DNF">DNF (Dynamic No Fins)</option>
                        <option value="STA">STA (Static Apnea)</option>
                      </select>
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Location
                      </label>
                      <input
                        type="text"
                        name="location"
                        value={newEntry.location}
                        onChange={handleInputChange}
                        placeholder="e.g., Blue Hole, Egypt"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                  </div>
                </div>

                {/* Depth Section */}
                <div
                  className={`p-4 rounded-lg ${darkMode ? "bg-gray-800 border border-gray-700" : "bg-green-50 border border-green-200"}`}
                >
                  <h4
                    className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                  >
                    üìè Depth Information
                  </h4>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Target Depth (m)
                      </label>
                      <input
                        type="number"
                        name="targetDepth"
                        value={newEntry.targetDepth}
                        onChange={handleInputChange}
                        placeholder="25"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Reached Depth (m)
                      </label>
                      <input
                        type="number"
                        name="reachedDepth"
                        value={newEntry.reachedDepth}
                        onChange={handleInputChange}
                        placeholder="23"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Mouthfill Depth (m)
                      </label>
                      <input
                        type="number"
                        name="mouthfillDepth"
                        value={newEntry.mouthfillDepth}
                        onChange={handleInputChange}
                        placeholder="15"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Issue Depth (m)
                      </label>
                      <input
                        type="number"
                        name="issueDepth"
                        value={newEntry.issueDepth}
                        onChange={handleInputChange}
                        placeholder="20"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                  </div>
                </div>

                {/* Performance Section */}
                <div
                  className={`p-4 rounded-lg ${darkMode ? "bg-gray-800 border border-gray-700" : "bg-purple-50 border border-purple-200"}`}
                >
                  <h4
                    className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                  >
                    ‚è±Ô∏è Performance Metrics
                  </h4>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Duration/Distance
                      </label>
                      <input
                        type="text"
                        name="durationOrDistance"
                        value={newEntry.durationOrDistance}
                        onChange={handleInputChange}
                        placeholder="2:30 or 50m"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Total Dive Time
                      </label>
                      <input
                        type="text"
                        name="totalDiveTime"
                        value={newEntry.totalDiveTime}
                        onChange={handleInputChange}
                        placeholder="3:45"
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Exit Condition
                      </label>
                      <input
                        type="text"
                        name="exit"
                        value={newEntry.exit}
                        onChange={handleInputChange}
                        placeholder="Clean, LMC, BO, etc."
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Attempt Type
                      </label>
                      <input
                        type="text"
                        name="attemptType"
                        value={newEntry.attemptType}
                        onChange={handleInputChange}
                        placeholder="Training, PB attempt, etc."
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                  </div>
                </div>

                {/* Issues & Notes Section */}
                <div
                  className={`p-4 rounded-lg ${darkMode ? "bg-gray-800 border border-gray-700" : "bg-orange-50 border border-orange-200"}`}
                >
                  <h4
                    className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                  >
                    ‚ö†Ô∏è Issues & Notes
                  </h4>
                  <div className="space-y-3">
                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Issue Comment
                      </label>
                      <textarea
                        name="issueComment"
                        value={newEntry.issueComment}
                        onChange={handleInputChange}
                        placeholder="Describe any issues encountered..."
                        rows={2}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>

                    <div>
                      <label
                        className={`flex items-center text-sm ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        <input
                          type="checkbox"
                          name="squeeze"
                          checked={newEntry.squeeze}
                          onChange={handleInputChange}
                          className="mr-2"
                        />
                        Squeeze experienced
                      </label>
                    </div>

                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Surface Protocol
                      </label>
                      <select
                        name="surfaceProtocol"
                        value={newEntry.surfaceProtocol}
                        onChange={handleInputChange}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      >
                        <option value="">Not specified</option>
                        <option value="ok">OK - Clean surface</option>
                        <option value="samba">Samba (minor)</option>
                        <option value="lmc">LMC (Loss of Motor Control)</option>
                        <option value="bo">BO (Blackout)</option>
                      </select>
                    </div>

                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Upload Dive Image
                      </label>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleImageChange}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:bg-blue-600 file:text-white hover:file:bg-blue-700"
                      />
                      {newEntry.imagePreview && (
                        <Image
                          src={newEntry.imagePreview}
                          alt="Preview"
                          width={128}
                          height={128}
                          className="mt-2 max-w-full h-32 object-cover rounded"
                        />
                      )}
                    </div>

                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        üìä Upload Dive Computer Log
                      </label>
                      <input
                        type="file"
                        accept=".log,.csv,.txt,.xls,.xlsx,.xml,.json"
                        onChange={(e) => {
                          const file = e.target.files[0];
                          if (file) {
                            setNewEntry(prev => ({
                              ...prev,
                              diveComputerFile: file,
                              diveComputerFileName: file.name
                            }));
                          }
                        }}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:bg-green-600 file:text-white hover:file:bg-green-700"
                      />
                      {newEntry.diveComputerFileName && (
                        <div className="mt-2 p-2 bg-green-900 rounded text-green-200 text-sm">
                          üìÑ {newEntry.diveComputerFileName}
                        </div>
                      )}
                      <p className="text-xs text-gray-400 mt-1">
                        Supported: .log, .csv, .txt, .xls, .xlsx, .xml, .json
                      </p>
                    </div>

                    <div>
                      <label
                        className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                      >
                        Notes
                      </label>
                      <textarea
                        name="notes"
                        value={newEntry.notes}
                        onChange={handleInputChange}
                        placeholder="How did the dive go? Any observations..."
                        rows={3}
                        className="w-full p-2 bg-gray-700 text-white rounded border border-gray-600"
                      />
                    </div>
                  </div>
                </div>

                <button
                  type="submit"
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-semibold transition-colors"
                >
                  {isSaving ? "‚è≥ Saving..." : "üíæ "}{isEditMode ? "Update Dive Entry" : "Save Dive Entry"}
                </button>
              </form>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Rest of the component for non-embedded (popup) mode would go here...
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div
        className={`${darkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"} rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col`}
      >
        {/* Header */}
        <div className="flex justify-between items-center p-6 border-b border-gray-200">
          <h2 className="text-xl font-semibold">ü§ø Dive Journal</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700 text-xl font-bold"
          >
            √ó
          </button>
        </div>

        {/* Same content as embedded version */}
        <div className="flex-1 overflow-hidden">
          <div className="h-full flex flex-col">
            {/* Tab Navigation for Popup */}
            <div
              className={`border-b ${darkMode ? "border-gray-700" : "border-gray-200"}`}
            >
              <div className="flex">
                <button
                  onClick={() => setActiveTab("saved-logs")}
                  className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                    activeTab === "saved-logs"
                      ? darkMode
                        ? "bg-blue-600 text-white border-b-2 border-blue-400"
                        : "bg-blue-500 text-white border-b-2 border-blue-400"
                      : darkMode
                        ? "text-gray-400 hover:text-white hover:bg-gray-800"
                        : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
                  }`}
                >
                  üíæ Saved Logs
                </button>
                <button
                  onClick={() => setActiveTab("batch-analysis")}
                  className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                    activeTab === "batch-analysis"
                      ? darkMode
                        ? "bg-blue-600 text-white border-b-2 border-blue-400"
                        : "bg-blue-500 text-white border-b-2 border-blue-400"
                      : darkMode
                        ? "text-gray-400 hover:text-white hover:bg-gray-800"
                        : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
                  }`}
                >
                  üìä Analysis
                </button>
                <button
                  onClick={() => setActiveTab("add-new")}
                  className={`flex-1 px-3 py-2 text-sm font-medium transition-colors ${
                    activeTab === "add-new"
                      ? darkMode
                        ? "bg-blue-600 text-white border-b-2 border-blue-400"
                        : "bg-blue-500 text-white border-b-2 border-blue-400"
                      : darkMode
                        ? "text-gray-400 hover:text-white hover:bg-gray-800"
                        : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
                  }`}
                >
                  ‚úçÔ∏è {isEditMode ? "Edit" : "New"}
                </button>
              </div>
            </div>

            {/* Tab Content */}
            <div className="flex-1 overflow-y-auto p-6">
              {/* Saved Dive Logs Tab Content - Same as embedded */}
              {activeTab === "saved-logs" && (
                <div className="space-y-4">
                  {loadingDiveLogs ? (
                    <div className="text-center py-8">
                      <div className="text-4xl mb-4">‚è≥</div>
                      <p
                        className={`text-lg font-medium ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                      >
                        Loading dive logs...
                      </p>
                    </div>
                  ) : !logs.length ? (
                    <div className="text-center py-8">
                      <div className="text-4xl mb-4">ü§ø</div>
                      <p
                        className={`text-lg font-medium ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                      >
                        No dive logs yet
                      </p>
                      <p
                        className={`text-sm mt-2 ${darkMode ? "text-gray-400" : "text-gray-500"}`}
                      >
                        Add your first dive using the &quot;Create New Dive Log&quot; tab!
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {/* Header with stats and sort */}
                      <div className="flex justify-between items-center">
                        <div
                          className={`text-sm ${darkMode ? "text-gray-300" : "text-gray-600"}`}
                        >
                          <span className="font-medium">{logs.length}</span>{" "}
                          dive{logs.length !== 1 ? "s" : ""} logged
                        </div>
                        <select
                          value={sortBy}
                          onChange={(e) => setSortBy(e.target.value)}
                          className={`text-xs px-2 py-1 rounded border ${
                            darkMode
                              ? "bg-gray-700 border-gray-600 text-white"
                              : "bg-white border-gray-300 text-gray-900"
                          }`}
                        >
                          <option value="date">Sort by Date</option>
                          <option value="depth">Sort by Depth</option>
                          <option value="location">Sort by Location</option>
                        </select>
                      </div>

                      {/* Dive Logs List */}
                      <div className="space-y-3">
                        {sortedLogs.map((log, index) => (
                          <div
                            key={log.id || index}
                            className={`p-4 rounded-lg border ${
                              darkMode
                                ? "bg-gray-700 border-gray-600"
                                : "bg-white border-gray-200"
                            }`}
                          >
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <div
                                  className={`font-medium ${darkMode ? "text-white" : "text-gray-900"}`}
                                >
                                  {new Date(log.date).toLocaleDateString()} -{" "}
                                  {log.discipline || "Freediving"}
                                </div>
                                <div
                                  className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-600"}`}
                                >
                                  üìç {log.location || "Unknown location"}
                                </div>
                                <div
                                  className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-600"}`}
                                >
                                  üéØ Target: {log.targetDepth || 0}m | Reached:{" "}
                                  {log.reachedDepth || 0}m
                                </div>
                                {log.notes && (
                                  <div
                                    className={`text-sm mt-2 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                                  >
                                    üìù {log.notes.slice(0, 100)}
                                    {log.notes.length > 100 ? "..." : ""}
                                  </div>
                                )}
                              </div>

                              {/* Action Buttons */}
                              <div className="flex flex-col gap-2 ml-4">
                                <button
                                  onClick={() => handleAnalyzeDiveLog(log)}
                                  disabled={analyzingLogId === log.id}
                                  className={`px-3 py-1 text-xs rounded transition-colors ${
                                    analyzingLogId === log.id
                                      ? "bg-gray-400 cursor-not-allowed"
                                      : darkMode
                                        ? "bg-blue-600 hover:bg-blue-700 text-white"
                                        : "bg-blue-500 hover:bg-blue-600 text-white"
                                  }`}
                                >
                                  {analyzingLogId === log.id
                                    ? "‚è≥ Analyzing..."
                                    : "ü§ñ Analyze"}
                                </button>
                                <button
                                  onClick={() => {
                                    // Set editing mode and switch to form tab
                                    setNewEntry({
                                      ...log,
                                      imageFile: null,
                                      imagePreview: log.imageUrl || null,
                                    });
                                    setIsEditMode(true);
                                    setActiveTab("add-new");
                                  }}
                                  className={`px-3 py-1 text-xs rounded transition-colors ${
                                    darkMode
                                      ? "bg-green-600 hover:bg-green-700 text-white"
                                      : "bg-green-500 hover:bg-green-600 text-white"
                                  }`}
                                >
                                  ‚úèÔ∏è Edit
                                </button>
                                <button
                                  onClick={() => handleDeleteDiveLog(log)}
                                  className={`px-3 py-1 text-xs rounded transition-colors ${
                                    darkMode
                                      ? "bg-red-600 hover:bg-red-700 text-white"
                                      : "bg-red-500 hover:bg-red-600 text-white"
                                  }`}
                                >
                                  üóëÔ∏è Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Batch Analysis Tab Content - Same as embedded */}
              {activeTab === "batch-analysis" && (
                <div className="space-y-6">
                  <div className="flex justify-between items-center">
                    <h3 className={`text-lg font-semibold ${darkMode ? "text-white" : "text-gray-900"}`}>
                      üìä Batch Analysis & Pattern Detection
                    </h3>
                    <button
                      onClick={handleExportLogs}
                      className={`text-sm px-3 py-1 rounded transition-colors ${
                        darkMode
                          ? "bg-green-600 hover:bg-green-700 text-white"
                          : "bg-green-500 hover:bg-green-600 text-white"
                      }`}
                    >
                      üìÅ Export CSV
                    </button>
                  </div>

                  {/* Analysis Controls */}
                  <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-700 border-gray-600" : "bg-gray-50 border-gray-200"}`}>
                    <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                      Analysis Settings
                    </h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                          Analysis Type
                        </label>
                        <select
                          value={analysisType}
                          onChange={(e) => setAnalysisType(e.target.value)}
                          className={`w-full px-3 py-2 text-sm rounded border ${
                            darkMode
                              ? "bg-gray-600 border-gray-500 text-white"
                              : "bg-white border-gray-300 text-gray-900"
                          }`}
                        >
                          <option value="pattern">üîç Pattern Detection</option>
                          <option value="safety">üõ°Ô∏è Safety Analysis</option>
                          <option value="performance">üìà Performance Review</option>
                          <option value="coaching">üéØ Coaching Insights</option>
                        </select>
                      </div>
                      <div>
                        <label className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                          Time Range
                        </label>
                        <select
                          value={timeRange}
                          onChange={(e) => setTimeRange(e.target.value)}
                          className={`w-full px-3 py-2 text-sm rounded border ${
                            darkMode
                              ? "bg-gray-600 border-gray-500 text-white"
                              : "bg-white border-gray-300 text-gray-900"
                          }`}
                        >
                          <option value="week">üìÖ Last Week</option>
                          <option value="month">üìÖ Last Month</option>
                          <option value="quarter">üìÖ Last 3 Months</option>
                          <option value="year">üìÖ Last Year</option>
                          <option value="all">üìÖ All Time</option>
                        </select>
                      </div>
                    </div>
                    <button
                      onClick={handleBatchAnalysis}
                      disabled={isAnalyzing || logs.length === 0}
                      className={`mt-4 w-full px-4 py-2 rounded transition-colors ${
                        isAnalyzing || logs.length === 0
                          ? "bg-gray-400 cursor-not-allowed text-white"
                          : darkMode
                            ? "bg-blue-600 hover:bg-blue-700 text-white"
                            : "bg-blue-500 hover:bg-blue-600 text-white"
                      }`}
                    >
                      {isAnalyzing 
                        ? "üîÑ Analyzing..." 
                        : logs.length === 0 
                          ? "‚ùå No Logs to Analyze" 
                          : `üöÄ Analyze ${logs.length} Dive${logs.length !== 1 ? 's' : ''}`
                      }
                    </button>
                  </div>

                  {/* Current Analysis Result */}
                  {batchAnalysis && (
                    <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-700 border-gray-600" : "bg-white border-gray-200"}`}>
                      <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                        üß† Latest Analysis Results
                      </h4>
                      <div className={`text-sm ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                        <div className="mb-2">
                          <span className="font-medium">Type:</span> {batchAnalysis.type} | 
                          <span className="font-medium"> Range:</span> {batchAnalysis.timeRange} | 
                          <span className="font-medium"> Logs:</span> {batchAnalysis.logsAnalyzed}
                        </div>
                        <div className={`p-3 rounded bg-gray-100 ${darkMode ? "bg-gray-600" : ""} whitespace-pre-wrap`}>
                          {batchAnalysis.result}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Analysis History */}
                  {analysisHistory.length > 0 && (
                    <div className={`p-4 rounded-lg border ${darkMode ? "bg-gray-700 border-gray-600" : "bg-white border-gray-200"}`}>
                      <h4 className={`font-medium mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}>
                        üìö Recent Analysis History
                      </h4>
                      <div className="space-y-2">
                        {analysisHistory.slice(0, 3).map((analysis, index) => (
                          <div
                            key={index}
                            className={`p-2 rounded border cursor-pointer ${
                              darkMode ? "bg-gray-600 border-gray-500 hover:bg-gray-500" : "bg-gray-50 border-gray-200 hover:bg-gray-100"
                            }`}
                            onClick={() => setBatchAnalysis(analysis)}
                          >
                            <div className={`text-xs ${darkMode ? "text-gray-300" : "text-gray-600"}`}>
                              {analysis.type} ‚Ä¢ {analysis.timeRange} ‚Ä¢ {analysis.logsAnalyzed} logs ‚Ä¢ {new Date(analysis.createdAt).toLocaleDateString()}
                            </div>
                            <div className={`text-sm ${darkMode ? "text-gray-400" : "text-gray-700"} truncate`}>
                              {analysis.result.substring(0, 100)}...
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Add New / Edit Dive Log Tab Content - Same as embedded */}
              {activeTab === "add-new" && (
                <div className="space-y-4">
                  <div className="flex justify-between items-center">
                    <h3
                      className={`text-lg font-semibold ${darkMode ? "text-white" : "text-gray-900"}`}
                    >
                      {isEditMode
                        ? "‚úèÔ∏è Edit Dive Log"
                        : "‚úçÔ∏è Create New Dive Log"}
                    </h3>
                    {isEditMode && (
                      <button
                        onClick={() => {
                          resetForm();
                          setActiveTab("saved-logs");
                        }}
                        className={`text-sm px-3 py-1 rounded ${
                          darkMode
                            ? "bg-gray-600 hover:bg-gray-700 text-gray-300"
                            : "bg-gray-200 hover:bg-gray-300 text-gray-700"
                        }`}
                      >
                        Cancel Edit
                      </button>
                    )}
                  </div>

                  <form onSubmit={handleSubmit} className="space-y-4">
                    {/* Basic Information */}
                    <div
                      className={`p-4 rounded-lg ${darkMode ? "bg-gray-700 border border-gray-600" : "bg-blue-50 border border-blue-200"}`}
                    >
                      <h4
                        className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                      >
                        üìÖ Basic Information
                      </h4>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Date
                          </label>
                          <input
                            name="date"
                            type="date"
                            value={newEntry.date}
                            onChange={handleInputChange}
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                            required
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Type
                          </label>
                          <select
                            name="disciplineType"
                            value={newEntry.disciplineType}
                            onChange={handleInputChange}
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          >
                            <option value="depth">Depth</option>
                            <option value="pool">Pool</option>
                          </select>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3 mt-3">
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Discipline
                          </label>
                          <input
                            type="text"
                            name="discipline"
                            value={newEntry.discipline}
                            onChange={handleInputChange}
                            placeholder="e.g., Freediving, Spearfishing"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}>
                            Location
                          </label>
                          <input
                            type="text"
                            name="location"
                            value={newEntry.location}
                            onChange={handleInputChange}
                            placeholder="e.g., Blue Hole, Egypt"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                      </div>
                    </div>

                    {/* Depth Section */}
                    <div
                      className={`p-4 rounded-lg ${darkMode ? "bg-gray-700 border border-gray-600" : "bg-green-50 border border-green-200"}`}
                    >
                      <h4
                        className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                      >
                        üìè Depth Information
                      </h4>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Target Depth (m)
                          </label>
                          <input
                            type="number"
                            name="targetDepth"
                            value={newEntry.targetDepth}
                            onChange={handleInputChange}
                            placeholder="25"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Reached Depth (m)
                          </label>
                          <input
                            type="number"
                            name="reachedDepth"
                            value={newEntry.reachedDepth}
                            onChange={handleInputChange}
                            placeholder="23"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Mouthfill Depth (m)
                          </label>
                          <input
                            type="number"
                            name="mouthfillDepth"
                            value={newEntry.mouthfillDepth}
                            onChange={handleInputChange}
                            placeholder="15"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Issue Depth (m)
                          </label>
                          <input
                            type="number"
                            name="issueDepth"
                            value={newEntry.issueDepth}
                            onChange={handleInputChange}
                            placeholder="20"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                      </div>
                    </div>

                    {/* Performance Section */}
                    <div
                      className={`p-4 rounded-lg ${darkMode ? "bg-gray-700 border border-gray-600" : "bg-purple-50 border border-purple-200"}`}
                    >
                      <h4
                        className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                      >
                        ‚è±Ô∏è Performance Metrics
                      </h4>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Duration/Distance
                          </label>
                          <input
                            type="text"
                            name="durationOrDistance"
                            value={newEntry.durationOrDistance}
                            onChange={handleInputChange}
                            placeholder="2:30 or 50m"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Total Dive Time
                          </label>
                          <input
                            type="text"
                            name="totalDiveTime"
                            value={newEntry.totalDiveTime}
                            onChange={handleInputChange}
                            placeholder="3:45"
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Exit Condition
                          </label>
                          <input
                            type="text"
                            name="exit"
                            value={newEntry.exit}
                            onChange={handleInputChange}
                            placeholder="Clean, LMC, BO, etc."
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Attempt Type
                          </label>
                          <input
                            type="text"
                            name="attemptType"
                            value={newEntry.attemptType}
                            onChange={handleInputChange}
                            placeholder="Training, PB attempt, etc."
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                      </div>
                    </div>

                    {/* Issues & Notes Section */}
                    <div
                      className={`p-4 rounded-lg ${darkMode ? "bg-gray-700 border border-gray-600" : "bg-orange-50 border border-orange-200"}`}
                    >
                      <h4
                        className={`text-sm font-semibold mb-3 ${darkMode ? "text-white" : "text-gray-900"}`}
                      >
                        ‚ö†Ô∏è Issues & Notes
                      </h4>
                      <div className="space-y-3">
                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Issue Comment
                          </label>
                          <textarea
                            name="issueComment"
                            value={newEntry.issueComment}
                            onChange={handleInputChange}
                            placeholder="Describe any issues encountered..."
                            rows={2}
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>

                        <div>
                          <label
                            className={`flex items-center text-sm ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            <input
                              type="checkbox"
                              name="squeeze"
                              checked={newEntry.squeeze}
                              onChange={handleInputChange}
                              className="mr-2"
                            />
                            Squeeze experienced
                          </label>
                        </div>

                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Surface Protocol
                          </label>
                          <input
                            type="text"
                            name="surfaceProtocol"
                            value={newEntry.surfaceProtocol}
                            onChange={handleInputChange}
                            placeholder="OK sign, breathing pattern, etc."
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>

                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Upload Dive Computer Log / Image
                          </label>
                          <input
                            type="file"
                            accept="image/*,.log,.csv,.txt"
                            onChange={handleImageChange}
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:bg-blue-600 file:text-white hover:file:bg-blue-700" : "bg-white text-gray-900 border-gray-300 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:bg-blue-600 file:text-white hover:file:bg-blue-700"}`}
                          />
                          {newEntry.imagePreview && (
                            <Image
                              src={newEntry.imagePreview}
                              alt="Preview"
                              width={128}
                              height={128}
                              className="mt-2 max-w-full h-32 object-cover rounded"
                            />
                          )}
                          <p className="text-xs text-gray-400 mt-1">
                            Images: JPG, PNG, etc. | Dive Computer Logs: .log, .csv, .txt
                          </p>
                        </div>

                        <div>
                          <label
                            className={`block text-sm font-medium mb-1 ${darkMode ? "text-gray-300" : "text-gray-700"}`}
                          >
                            Notes
                          </label>
                          <textarea
                            name="notes"
                            value={newEntry.notes}
                            onChange={handleInputChange}
                            placeholder="How did the dive go? Any observations..."
                            rows={3}
                            className={`w-full p-2 rounded border ${darkMode ? "bg-gray-600 text-white border-gray-500" : "bg-white text-gray-900 border-gray-300"}`}
                          />
                        </div>
                      </div>
                    </div>

                    <button
                      type="submit"
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-semibold transition-colors"
                    >
                      üíæ {isEditMode ? "Update Dive Entry" : "Save Dive Entry"}
                    </button>
                  </form>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
