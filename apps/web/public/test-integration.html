<!DOCTYPE html>
<html>
<head>
    <title>KovalAI Dive Integration Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .result { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            white-space: pre-wrap; 
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .loading { border-left: 4px solid #2196F3; }
        button { 
            background: #007cba; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #005a87; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ü§ø KovalAI Complete Integration Test</h1>
    
    <div class="test-section">
        <h3>üìã Test 1: OpenAI + Pinecone Knowledge Retrieval</h3>
        <button onclick="testKnowledgeRetrieval()">Test Knowledge Base</button>
        <div id="knowledge-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>üì∏ Test 2: Dive Image OCR & Analysis</h3>
        <input type="file" id="imageFile" accept="image/*" />
        <button onclick="testImageUpload()">Upload & Analyze Dive Image</button>
        <div id="image-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>üíæ Test 3: Supabase Data Storage</h3>
        <button onclick="testSupabaseConnection()">Test Database Connection</button>
        <button onclick="testDiveLogSave()">Save Test Dive Log</button>
        <div id="supabase-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>üîÑ Test 4: Complete Pipeline</h3>
        <button onclick="runCompleteTest()">Run Full Integration Test</button>
        <div id="complete-result" class="result"></div>
    </div>

    <script>
        async function testKnowledgeRetrieval() {
            const resultDiv = document.getElementById('knowledge-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'üîç Testing OpenAI + Pinecone knowledge retrieval...';
            
            try {
                const response = await fetch('/api/chat/general', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'What is mouthfill equalization and when should I use it?',
                        userId: 'test-user-knowledge',
                        userLevel: 'beginner'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ SUCCESS - Knowledge Retrieved!\n\nResponse: ${result.response}\n\nContext chunks: ${result.contextChunks || 'unknown'}\nUser level: ${result.userLevel || 'unknown'}\nProcessing time: ${result.processingTime || 'unknown'}`;
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå FAILED: ${error.message}`;
            }
        }
        
        async function testImageUpload() {
            const resultDiv = document.getElementById('image-result');
            const fileInput = document.getElementById('imageFile');
            
            if (!fileInput.files[0]) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please select an image file first';
                return;
            }
            
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'üì∏ Uploading and analyzing dive image...';
            
            try {
                const formData = new FormData();
                formData.append('imageFile', fileInput.files[0]);
                formData.append('userId', 'test-user-image');
                
                const response = await fetch('/api/openai/upload-dive-image-simple', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ SUCCESS - Image Processed!\n\nExtracted Text: ${result.extractedText || 'none'}\n\nAnalysis: ${result.analysis || 'none'}\n\nDepth: ${result.depth}m\nTime: ${result.time}s\nDiscipline: ${result.discipline}`;
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå FAILED: ${error.message}`;
            }
        }
        
        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('supabase-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'üíæ Testing Supabase connection...';
            
            try {
                const response = await fetch('/api/supabase/dive-logs-optimized?userId=test-connection');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ SUCCESS - Supabase Connected!\n\nData received: ${JSON.stringify(result, null, 2)}`;
                } else {
                    throw new Error(result.error || result.details || 'Connection failed');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå FAILED: ${error.message}`;
            }
        }
        
        async function testDiveLogSave() {
            const resultDiv = document.getElementById('supabase-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'üíæ Testing dive log save...';
            
            try {
                const testDiveLog = {
                    userId: 'test-user-save',
                    date: new Date().toISOString(),
                    discipline: 'CWT',
                    location: 'Test Pool',
                    reached_depth: 25,
                    target_depth: 30,
                    total_time_seconds: 45,
                    notes: 'Test dive log from integration test'
                };
                
                const response = await fetch('/api/supabase/save-dive-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ diveLogData: testDiveLog })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ SUCCESS - Dive Log Saved!\n\nSaved log ID: ${result.id}\nData: ${JSON.stringify(result, null, 2)}`;
                } else {
                    throw new Error(result.error || 'Save failed');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå FAILED: ${error.message}`;
            }
        }
        
        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'üîÑ Running complete integration test...\n\n';
            
            let log = '';
            
            // Test 1: Knowledge
            log += '1. Testing knowledge retrieval...\n';
            try {
                const knowledgeResponse = await fetch('/api/chat/general', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'What is the safest depth for freediving?',
                        userId: 'test-complete',
                        userLevel: 'intermediate'
                    })
                });
                const knowledgeResult = await knowledgeResponse.json();
                log += knowledgeResponse.ok ? '   ‚úÖ Knowledge retrieval: SUCCESS\n' : '   ‚ùå Knowledge retrieval: FAILED\n';
            } catch (e) {
                log += '   ‚ùå Knowledge retrieval: ERROR\n';
            }
            
            // Test 2: Database connection
            log += '2. Testing database connection...\n';
            try {
                const dbResponse = await fetch('/api/supabase/dive-logs-optimized?userId=test-complete');
                const dbResult = await dbResponse.json();
                log += dbResponse.ok ? '   ‚úÖ Database connection: SUCCESS\n' : '   ‚ùå Database connection: FAILED\n';
            } catch (e) {
                log += '   ‚ùå Database connection: ERROR\n';
            }
            
            // Test 3: Sample dive save
            log += '3. Testing dive log save...\n';
            try {
                const saveResponse = await fetch('/api/supabase/save-dive-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        diveLogData: {
                            userId: 'test-complete',
                            date: new Date().toISOString(),
                            discipline: 'FIM',
                            reached_depth: 30,
                            notes: 'Complete integration test dive'
                        }
                    })
                });
                const saveResult = await saveResponse.json();
                log += saveResponse.ok ? '   ‚úÖ Dive log save: SUCCESS\n' : '   ‚ùå Dive log save: FAILED\n';
            } catch (e) {
                log += '   ‚ùå Dive log save: ERROR\n';
            }
            
            log += '\nüéâ Integration test complete!';
            
            resultDiv.className = 'result success';
            resultDiv.textContent = log;
        }
    </script>
</body>
</html>
